<?xml version="1.0" encoding="utf-8" ?>
<Project ToolsVersion="12.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <PostBuildEventDependsOn>
      $(PostBuildEventDependsOn);
      BuildNugetPackage
    </PostBuildEventDependsOn>

    <BuildDependsOn>
      CheckForReadOnlyDictionary;
      $(BuildDependsOn);
      BuildNugetPackage
    </BuildDependsOn>
    <Net35LibDir>$(MSBuildProjectDirectory)/NuGetBuild/lib/net35</Net35LibDir>
  </PropertyGroup>

  <Target Name="BuildForFx35">
    <MakeDir Directories="$(Net35LibDir)"/>

    <MSBuild Condition=""
             Projects="$(MSBuildProjectFullPath)"
             Targets="Rebuild"
             Properties="Platform=$(Platform);BuildNugetPackage=false;Configuration=$(Configuration);TargetFrameworkVersion=v3.5;TargetFrameworkProfile=Client;OutputPath=$(Net35LibDir)" />
  </Target>

  <Target Name="BuildNugetPackage" Condition="'$(BuildNugetPackage)' == 'true' and '$(TargetFrameworkVersion)' != 'v3.5'">
    <RemoveDir Condition="exists('$(Net35LibDir)')" Directories="$(Net35LibDir)"/>
    
    <CallTarget Condition="'$(Framework35Dir)' != '' and exists('$(Framework35Dir)')" Targets="BuildForFx35"/>
  </Target>

  <Target Name="CheckForReadOnlyDictionary" BeforeTargets="CoreBuild">
    <PropertyGroup Condition ="'$(TargetFrameworkVersion)' != 'v3.5' and '$(TargetFrameworkVersion)' != 'v4.0'">
      <DefineConstants>$(DefineConstants) ReadOnlyDictionary</DefineConstants>
    </PropertyGroup>
  </Target>


  <Target Name="DllExportFindNugetVersion"
          Condition="'$(BuildNugetPackage)' == 'true' and '$(NuGetCommand)' == '' and '$(NuGetToolsPath)' == ''"
          BeforeTargets="BuildNugetPackage">
    <XmlPeek XmlInputPath="$(SolutionDir).nuget/packages.config"
             Query="/packages/package[@id='NuGet.CommandLine']/@version">
      <Output TaskParameter="Result"
              ItemName="NugetCommandLineVersionItem"/>
    </XmlPeek>
    <PropertyGroup>
      <NugetCommandLineVersion Condition="'$(NugetCommandLineVersion)' == ''">@(NugetCommandLineVersionItem)</NugetCommandLineVersion>
    </PropertyGroup>

    <CreateProperty Condition="'$(NuGetToolsPath)' == ''"
                    Value="$(SolutionDir)packages/NuGet.CommandLine.$(NugetCommandLineVersion)\tools">
      <Output TaskParameter="Value"
              PropertyName="NuGetToolsPath"></Output>
    </CreateProperty>
  </Target>

  <Target Name="DllExportSetupNuGetCommand" Condition="'$(NuGetCommand)' == '' and '$(NuGetToolsPath)' != ''"
  AfterTargets="DllExportFindNugetVersion"
  BeforeTargets="BuildNugetPackage">
    <PropertyGroup>
      <NuGetExePath Condition=" '$(NuGetExePath)' == '' ">$(NuGetToolsPath)\NuGet.exe</NuGetExePath>

      <NuGetCommand Condition=" '$(OS)' == 'Windows_NT'">"$(NuGetExePath)"</NuGetCommand>
      <NuGetCommand Condition=" '$(OS)' != 'Windows_NT' ">mono --runtime=v4.0.30319 "$(NuGetExePath)"</NuGetCommand>
    </PropertyGroup>
  </Target>

</Project>